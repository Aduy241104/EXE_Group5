import api from '../../lib/api';
// src/components/layout/Topbar.jsx
import { useContext, useState, useEffect, useRef, useCallback } from "react";
import { Link, useLocation, useNavigate } from "react-router-dom";
import { AuthContext } from "../../context/AuthContext";
import {
  Heart,
  MessageCircle,
  PlusCircle,
  User,
  ListChecks,
  BarChart3,
  LogOut,
  Shield,
  CheckCircle2,
  Menu,
  Bell,
  Trash2,
  CheckCheck,
} from "lucide-react";

import { io } from "socket.io-client";

const API = import.meta.env.VITE_API_URL || 'http://localhost:5000';

// Kh·ªüi t·∫°o socket 1 l·∫ßn
const socket = io(API, { transports: ["websocket"], autoConnect: true });

export default function Topbar() {
  const { user, logout, token } = useContext(AuthContext);

  const [isScrolled, setIsScrolled] = useState(false);
  const [open, setOpen] = useState(false);

  // search
  const [searchTerm, setSearchTerm] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [loading, setLoading] = useState(false);

  // notifications
  const [nbOpen, setNbOpen] = useState(false);
  const [notifs, setNotifs] = useState([]);
  const [nbUnread, setNbUnread] = useState(0);

  const isAdmin = (user?.role || "").toLowerCase() === "admin";

  const dropdownRef = useRef(null);
  const nbRef = useRef(null);

  const location = useLocation();
  const navigate = useNavigate();

  /* ===================== UI helpers ===================== */
  const onToggleSidebar = () => {
    window.dispatchEvent(new CustomEvent("sidebar:toggle"));
    document.body.classList.toggle("sidebar-open");
  };

  useEffect(() => {
    const handleScroll = () => setIsScrolled(window.scrollY > 50);
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  // ƒê√≥ng dropdown user khi click ra ngo√†i
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // ƒê√≥ng dropdown th√¥ng b√°o khi click ra ngo√†i
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (nbRef.current && !nbRef.current.contains(e.target)) {
        setNbOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // ƒê·ªìng b·ªô khi quay l·∫°i tab (token v·∫´n valid)
  useEffect(() => {
    const onFocus = async () => {
      if (!token) return;
      try {
        await api.get(`${API}/api/auth/me`, {
          headers: { Authorization: `Bearer ${token}` },
        });
      } catch {
        /* ignore */
      }
    };
    window.addEventListener("focus", onFocus);
    return () => window.removeEventListener("focus", onFocus);
  }, [token]);

  /* ===================== SEARCH ===================== */
  useEffect(() => {
    if (!searchTerm.trim()) {
      setSuggestions([]);
      return;
    }
    const t = setTimeout(async () => {
      try {
        setLoading(true);
        const res = await api.get(`${API}/api/products/search`, {
          params: { q: searchTerm },
        });
        setSuggestions((res.data || []).slice(0, 6));
      } catch {
        /* ignore */
      } finally {
        setLoading(false);
      }
    }, 300);
    return () => clearTimeout(t);
  }, [searchTerm]);

  const handleSearch = (e) => {
    e.preventDefault();
    if (!searchTerm.trim()) return;
    navigate(`/search?q=${encodeURIComponent(searchTerm.trim())}`);
    setSuggestions([]);
  };

  /* ===================== NOTIFICATIONS ===================== */
  const loadNotifs = useCallback(async () => {
    if (!token || !user) return;
    try {
      const res = await api.get(`${API}/api/notifications`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      setNotifs(res.data.items || []);
      setNbUnread(res.data.unread || 0);
    } catch {
      // 403 khi ch∆∞a ph·∫£i admin ch·ªâ ·∫£nh h∆∞·ªüng ƒë·∫øn POST; GET v·∫´n cho user th∆∞·ªùng
    }
  }, [token, user]);

  // Ch·ªâ load khi ƒë√£ c√≥ token & user
  useEffect(() => {
    if (!token || !user) return;
    loadNotifs();
  }, [token, user, loadNotifs]);

  // Realtime: l·∫Øng nghe k√™nh ri√™ng c·ªßa user
  useEffect(() => {
    if (!user?.id) return;
    const channel = `notification:new:${user.id}`;
    const handler = (payload) => {
      setNotifs((prev) => [
        {
          id: `tmp-${Date.now()}`,
          title: payload?.title || "Th√¥ng b√°o",
          body: payload?.body || "",
          is_read: false,
          created_at: new Date().toISOString(),
        },
        ...prev,
      ]);
      setNbUnread((x) => x + 1);
    };
    socket.on(channel, handler);
    return () => socket.off(channel, handler);
  }, [user?.id]);

  const markAllRead = async () => {
    if (!token) return;
    try {
      await api.patch(
        `${API}/api/notifications/read-all`,
        {},
        { headers: { Authorization: `Bearer ${token}` } }
      );
    } catch {
      /* ignore */
    }
    setNotifs((prev) => prev.map((n) => ({ ...n, is_read: true })));
    setNbUnread(0);
  };

  const clearAllNotifs = async () => {
    if (!token) return;
    try {
      await api.delete(`${API}/api/notifications`, {
        headers: { Authorization: `Bearer ${token}` },
      });
    } catch {
      /* ignore */
    }
    setNotifs([]);
    setNbUnread(0);
  };

  return (
    // tƒÉng z-index c·ªßa header ƒë·ªÉ che n·ªôi dung trang
    <header className="bg-gradient-to-r from-orange-500 to-yellow-400 text-white shadow-md sticky top-0 z-[60]">
      <div className={isScrolled ? "py-2" : "py-4"}>
        <div className="container mx-auto flex items-center justify-between px-6 relative">
          {/* tr√°i: menu + logo */}
          <div className="flex items-center gap-3">
            <button
              type="button"
              onClick={onToggleSidebar}
              aria-label="M·ªü menu"
              className="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/25 hover:bg-white/35 shadow"
            >
              <Menu className="w-6 h-6 text-white" />
            </button>

            <Link to="/" className="flex items-center gap-2 ml-1 md:ml-2">
              <img
                src="/logo.png"
                alt="UniTrade"
                className="h-12 w-12 object-contain bg-white rounded-full shadow"
              />
              <span className="text-2xl font-bold">
                Uni<span className="text-yellow-200">Trade</span>
              </span>
            </Link>
          </div>

          {/* search */}
          <form
            onSubmit={handleSearch}
            className="relative flex bg-white rounded-full shadow overflow-hidden w-full max-w-[720px] mx-4"
          >
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..."
              className="flex-1 px-4 py-2 text-gray-700 focus:outline-none"
            />
            <button
              type="submit"
              className="bg-orange-600 px-5 font-semibold hover:bg-orange-700 transition"
            >
              T√¨m
            </button>

            {suggestions.length > 0 && (
              <ul className="absolute top-full left-0 w-full bg-white text-gray-800 rounded-lg shadow-lg z-[70] mt-1 overflow-hidden">
                {loading ? (
                  <li className="px-4 py-3 text-center text-sm text-gray-500">
                    ƒêang t√¨m ki·∫øm...
                  </li>
                ) : (
                  suggestions.map((p) => (
                    <li
                      key={p.id}
                      className="flex items-center gap-3 px-4 py-2 hover:bg-gray-100 cursor-pointer"
                      onClick={() => navigate(`/products/${p.id}`)}
                    >
                      <img
                        src={
                          p.image_url ||
                          "https://via.placeholder.com/80x80?text=No+Image"
                        }
                        alt={p.name}
                        className="w-10 h-10 rounded object-cover border"
                      />
                      <div className="min-w-0">
                        <p className="font-medium truncate">{p.name}</p>
                        <p className="text-xs text-gray-500">
                          {new Intl.NumberFormat("vi-VN").format(p.price || 0)} ƒë
                        </p>
                      </div>
                    </li>
                  ))
                )}
              </ul>
            )}
          </form>

          {/* ph·∫£i */}
          <div className="flex items-center gap-3 ml-4">
            <Link
              to="/favorites"
              aria-label="Tin y√™u th√≠ch"
              className="p-2 rounded-full hover:bg-white/15"
            >
              <Heart className="w-7 h-7 text-pink-100" />
            </Link>
            <Link
              to="/messages"
              aria-label="Tin nh·∫Øn"
              className="p-2 rounded-full hover:bg-white/15"
            >
              <MessageCircle className="w-7 h-7 text-blue-100" />
            </Link>
            <Link
              to="/post/create"
              aria-label="ƒêƒÉng b√†i"
              className="p-2 rounded-full hover:bg-white/15"
            >
              <PlusCircle className="w-7 h-7 text-emerald-100" />
            </Link>

            {/* chu√¥ng */}
            {user && (
              <div className="relative" ref={nbRef}>
                <button
                  onClick={() => setNbOpen((v) => !v)}
                  className="relative p-2 rounded-full hover:bg-white/15"
                  aria-label="Th√¥ng b√°o"
                >
                  <Bell className="w-7 h-7 text-white/95" />
                  {nbUnread > 0 && (
                    <span className="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 bg-red-500 text-white text-[11px] rounded-full flex items-center justify-center">
                      {nbUnread > 99 ? "99+" : nbUnread}
                    </span>
                  )}
                </button>

                {/* z-index cao ƒë·ªÉ kh√¥ng b·ªã slogan ƒë√® */}
                <div
                  className={`absolute right-0 mt-2 w-[22rem] bg-white text-gray-800 rounded-xl shadow-xl border border-gray-100 origin-top-right transform transition duration-150 z-[90] ${
                    nbOpen
                      ? "opacity-100 scale-100"
                      : "opacity-0 scale-95 pointer-events-none"
                  }`}
                >
                  <div className="px-4 py-3 border-b flex items-center justify-between sticky top-0 bg-white z-[1] rounded-t-xl">
                    <div className="font-semibold">Th√¥ng b√°o</div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={markAllRead}
                        className="text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200"
                      >
                        <CheckCheck className="w-4 h-4" /> ƒê√£ ƒë·ªçc
                      </button>
                      <button
                        onClick={clearAllNotifs}
                        className="text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-red-600"
                      >
                        <Trash2 className="w-4 h-4" /> Xo√°
                      </button>
                    </div>
                  </div>

                  <div className="max-h-96 overflow-y-auto">
                    {notifs.length === 0 ? (
                      <div className="px-4 py-6 text-sm text-gray-500 text-center">
                        Ch∆∞a c√≥ th√¥ng b√°o.
                      </div>
                    ) : (
                      notifs.map((n) => (
                        <div
                          key={n.id}
                          className={`px-4 py-3 border-b last:border-b-0 ${
                            n.is_read ? "bg-white" : "bg-orange-50"
                          }`}
                        >
                          <div className="text-sm font-medium">{n.title}</div>
                          {n.body && (
                            <div className="text-sm text-gray-600 mt-0.5">
                              {n.body}
                            </div>
                          )}
                          <div className="text-xs text-gray-400 mt-1">
                            {new Date(n.created_at).toLocaleString("vi-VN")}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* user menu */}
            {user ? (
              <div className="relative" ref={dropdownRef}>
                <button
                  onClick={() => setOpen(!open)}
                  className="flex items-center gap-2 focus:outline-none"
                >
                  <span className="hidden md:block font-medium">
                    Xin ch√†o, {user.username || user.email}
                  </span>
                  <User className="w-8 h-8" />
                  {isAdmin && (
                    <CheckCircle2
                      className="w-4 h-4 text-green-300 ml-1"
                      title="Admin verified"
                    />
                  )}
                </button>

                {open && (
                  <div className="absolute right-0 mt-2 w-56 bg-white text-gray-700 rounded-lg shadow-lg z-[80] overflow-hidden">
                    <Link
                      to="/profile"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <User className="w-4 h-4 text-sky-500" /> H·ªì s∆° chi ti·∫øt
                    </Link>

                    <Link
                      to="/myposts"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <PlusCircle className="w-4 h-4 text-emerald-500" /> Tin ƒë√£
                      ƒëƒÉng
                    </Link>

                    <Link
                      to="/favorites"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <Heart className="w-4 h-4 text-pink-500" /> Tin y√™u th√≠ch
                    </Link>

                    <Link
                      to="/orders/buyer"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <ListChecks className="w-4 h-4 text-indigo-600" /> ƒê∆°n h√†ng
                      c·ªßa t√¥i
                    </Link>

                    <Link
                      to="/seller/orders"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <ListChecks className="w-4 h-4 text-purple-600" /> Qu·∫£n l√Ω
                      ƒë∆°n b√°n
                    </Link>

                    <Link
                      to="/seller/dashboard"
                      className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100"
                      onClick={() => setOpen(false)}
                    >
                      <BarChart3 className="w-4 h-4 text-orange-500" /> B·∫£ng ƒëi·ªÅu
                      khi·ªÉn b√°n h√†ng
                    </Link>

                    {isAdmin && (
                      <>
                        <Link
                          to="/admin/users"
                          className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 font-medium"
                          onClick={() => setOpen(false)}
                        >
                          <Shield className="w-4 h-4 text-indigo-600" /> Qu·∫£n tr·ªã
                          ng∆∞·ªùi d√πng
                        </Link>
                        <Link
                          to="/admin/notify"
                          className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 font-medium"
                          onClick={() => setOpen(false)}
                        >
                          <Bell className="w-4 h-4 text-orange-600" /> G·ª≠i th√¥ng
                          b√°o
                        </Link>
                      </>
                    )}

                    <button
                      onClick={() => {
                        logout();
                        setOpen(false);
                      }}
                      className="w-full flex items-center gap-2 text-left px-4 py-2 text-red-500 hover:bg-gray-100"
                    >
                      <LogOut className="w-4 h-4" /> ƒêƒÉng xu·∫•t
                    </button>
                  </div>
                )}
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <Link
                  to="/login"
                  className="bg-white text-orange-600 px-4 py-2 rounded-full font-semibold"
                >
                  ƒêƒÉng nh·∫≠p
                </Link>
                <Link
                  to="/register"
                  className="px-4 py-2 rounded-full font-semibold border border-white/70"
                >
                  ƒêƒÉng k√Ω
                </Link>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Slogan lu√¥n hi·ªÉn th·ªã, ƒë·∫∑t z th·∫•p h∆°n dropdown */}
      {location.pathname === "/" && (
        <div className="container mx-auto text-center px-6 pb-8 relative z-[10]">
          <h1 className="text-4xl md:text-5xl font-extrabold mb-3 drop-shadow">
            UniTrade ‚Äì{" "}
            <span className="text-yellow-100">
              An To√†n - Ti·ªán L·ª£i ‚Äì Tin C·∫≠y
            </span>
          </h1>
          <p className="text-lg md:text-xl opacity-90">
            S√†n Th∆∞∆°ng M·∫°i ƒêi·ªán T·ª≠ D√†nh Cho Sinh Vi√™n
          </p>
        </div>
      )}
    </header>
  );
}
