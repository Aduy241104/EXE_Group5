import api from '../../lib/api';
import { useEffect, useState, useContext, useMemo } from "react";
import { useParams, useNavigate } from "react-router-dom";

import { AuthContext } from "../../context/AuthContext";
import { toast } from "react-hot-toast";

const API = import.meta.env.VITE_API_URL || 'http://localhost:5000';

// ===== Helpers an to√†n s·ªë =====
const num = (v, def = 0) => {
  const n = typeof v === "string" ? parseFloat(v) : Number(v);
  return Number.isFinite(n) ? n : def;
};
const clamp = (x, min, max) => Math.max(min, Math.min(max, x));
const stars = (x) => {
  const r = Math.round(clamp(num(x), 0, 5));
  return "‚òÖ".repeat(r) + "‚òÜ".repeat(5 - r);
};
const fmt1 = (x) => num(x).toFixed(1);
const fmtVND = (x) => new Intl.NumberFormat("vi-VN").format(num(x)) + " ƒë";

const ProductDetail = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { user, token } = useContext(AuthContext);

  const [product, setProduct] = useState(null);
  const [loading, setLoading] = useState(true);
  const [quantity, setQuantity] = useState(1);

  const [sellerProfile, setSellerProfile] = useState(null);
  const [sellerBadges, setSellerBadges] = useState([]);

  const [reviews, setReviews] = useState([]);
  const [newRating, setNewRating] = useState(5);
  const [newComment, setNewComment] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [reviewFiles, setReviewFiles] = useState([]); // ·∫£nh ch·ªçn ƒë·ªÉ upload

  // T√≠nh sao TB & breakdown 1..5 t·ª´ danh s√°ch reviews (FE-side)
  const ratingSummary = useMemo(() => {
    const total = reviews.length || 0;
    const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let sum = 0;
    for (const r of reviews) {
      const v = clamp(num(r?.rating, 0), 1, 5);
      counts[v] = (counts[v] || 0) + 1;
      sum += v;
    }
    const avg = total ? sum / total : 0;
    return { total, counts, avg };
  }, [reviews]);

  // Gi√° tr·ªã hi·ªÉn th·ªã an to√†n
  const avgDisplay = useMemo(() => {
    return num(product?.rating_avg ?? ratingSummary.avg, 0);
  }, [product?.rating_avg, ratingSummary.avg]);

  const countDisplay = useMemo(() => {
    return num(product?.rating_count ?? ratingSummary.total, 0);
  }, [product?.rating_count, ratingSummary.total]);

  const isAdmin = (user?.role || "").toLowerCase() === "admin";
  const canDelete =
    isAdmin ||
    (product?.seller_id && user?.id && Number(product.seller_id) === Number(user.id));

  useEffect(() => {
    const fetchProduct = async () => {
      try {
        const res = await api.get(`${API}/api/products/${id}`);
        setProduct(res.data);

        if (res.data?.seller_id) {
          try {
            const pr = await api.get(
              `${API}/api/profile/${res.data.seller_id}/public`
            );
            setSellerProfile(pr.data?.profile || null);
            setSellerBadges(pr.data?.badges || []);
          } catch {}
        }

        const rv = await api.get(`${API}/api/products/${id}/reviews`);
        setReviews(Array.isArray(rv.data) ? rv.data : []);
      } catch (err) {
        console.error("‚ùå L·ªói khi load chi ti·∫øt s·∫£n ph·∫©m:", err);
      } finally {
        setLoading(false);
      }
    };
    if (id) fetchProduct();
  }, [id]);

  const handleOrder = async () => {
    if (!user) {
      toast.error("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o y√™u c·∫ßu mua.");
      return;
    }
    if (!product) return;

    const qty = parseInt(quantity, 10);
    if (Number.isNaN(qty) || qty <= 0) {
      toast.error("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.");
      return;
    }

    if (product.seller_id && Number(product.seller_id) === Number(user.id)) {
      toast("B·∫°n kh√¥ng th·ªÉ mua s·∫£n ph·∫©m c·ªßa ch√≠nh m√¨nh.");
      return;
    }

    try {
      await api.post(
        `${API}/api/orders`,
        { product_id: product.id, quantity: qty },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      toast.success("üéâ ƒê√£ t·∫°o y√™u c·∫ßu mua!");
      navigate("/orders/buyer");
    } catch (err) {
      console.error("‚ùå L·ªói khi t·∫°o ƒë∆°n:", err);
      toast.error("Kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu mua.");
    }
  };

  // üóëÔ∏è X√ìA s·∫£n ph·∫©m (admin ho·∫∑c ch·ªß s·ªü h·ªØu)
  const handleDeleteProduct = async () => {
    if (!canDelete) return;
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.")) return;
    try {
      await api.delete(`${API}/api/products/${product.id}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      toast.success("ƒê√£ x√≥a s·∫£n ph·∫©m.");
      navigate("/products");
    } catch (err) {
      console.error("‚ùå L·ªói x√≥a s·∫£n ph·∫©m:", err);
      toast.error(err?.response?.data?.error || "Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.");
    }
  };

  // G·ª≠i review k√®m ·∫£nh (multipart)
  const submitReview = async () => {
    if (!user) {
      toast.error("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°.");
      return;
    }
    if (!newComment.trim()) {
      toast.error("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°.");
      return;
    }

    try {
      setSubmitting(true);
      const fd = new FormData();
      fd.append("rating", String(newRating));
      fd.append("content", newComment);
      reviewFiles.forEach((file) => fd.append("images", file));

      await api.post(`${API}/api/products/${id}/reviews`, fd, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "multipart/form-data",
        },
      });

      toast.success("C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!");
      setNewComment("");
      setNewRating(5);
      setReviewFiles([]);

      const rv = await api.get(`${API}/api/products/${id}/reviews`);
      setReviews(Array.isArray(rv.data) ? rv.data : []);
    } catch (err) {
      console.error(err);
      toast.error("Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°.");
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) return <p className="text-center py-10">ƒêang t·∫£i...</p>;
  if (!product) return <p className="text-center py-10">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m.</p>;

  return (
    <div className="container mx-auto px-6 py-10">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
        <div className="flex justify-center">
          <img
            src={product.image_url || "https://placehold.co/500x500?text=UniTrade"}
            alt={product.name}
            className="rounded-lg shadow-lg max-h-[500px] object-cover"
          />
        </div>

        <div>
          <h1 className="text-3xl font-bold mb-1">{product.name}</h1>

          {/* ‚≠ê Sao trung b√¨nh c·ªßa s·∫£n ph·∫©m */}
          <div className="flex items-center gap-3 mb-3">
            <div className="text-yellow-500 text-xl">{stars(avgDisplay)}</div>
            <div className="text-sm text-gray-600">
              {fmt1(avgDisplay)} / 5 ‚Ä¢ {countDisplay} ƒë√°nh gi√°
            </div>
          </div>

          <p className="text-orange-600 text-2xl font-semibold mb-4">
            {fmtVND(product.price)}
          </p>
          <p className="text-gray-700 mb-6">{product.description}</p>

          <div className="bg-gray-100 p-4 rounded-lg shadow mb-6">
            <h2 className="font-semibold text-lg mb-2">Th√¥ng tin ng∆∞·ªùi b√°n</h2>
            <p>
              <span className="font-medium">T√™n:</span> {product.seller_name}
            </p>
            {product.seller_phone && (
              <p>
                <span className="font-medium">SƒêT:</span> {product.seller_phone}
              </p>
            )}

            {sellerBadges.length > 0 && (
              <div className="mt-3">
                <div className="text-sm text-gray-600 mb-1">Huy hi·ªáu:</div>
                <div className="flex flex-wrap gap-2">
                  {sellerBadges.map((b) => (
                    <span
                      key={b.code}
                      className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white border text-xs"
                    >
                      <span>üèÖ</span>
                      <span className="font-medium">{b.title}</span>
                    </span>
                  ))}
                </div>
              </div>
            )}

            {sellerProfile && (
              <div className="mt-3 grid grid-cols-2 gap-2 text-sm">
                <div>
                  ‚≠ê ƒê√°nh gi√° TB: <b>{fmt1(sellerProfile.rating_avg_overall)}</b> (
                  {num(sellerProfile.rating_count_overall)}
                  )
                </div>
                <div>üõí ƒê√£ b√°n: <b>{num(sellerProfile.total_sold)}</b></div>
                <div>‚ö° T·ªâ l·ªá ph·∫£n h·ªìi: <b>{num(sellerProfile.response_rate)}%</b></div>
                <div>‚è±Ô∏è Ph·∫£n h·ªìi TB: <b>{num(sellerProfile.response_avg_minutes)}‚Ä≤</b></div>
              </div>
            )}
          </div>

          <div className="flex flex-col gap-4 md:flex-row md:items-center">
            {product.seller_phone && (
              <a
                href={`tel:${product.seller_phone}`}
                className="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition"
              >
                üìû G·ªçi ngay
              </a>
            )}

            <button
              className="bg-yellow-400 text-white px-6 py-2 rounded-lg hover:bg-yellow-500 transition"
              onClick={() =>
                navigate("/messages", {
                  state: {
                    sellerId: product.seller_id,
                    sellerName: product.seller_name,
                  },
                })
              }
            >
              üí¨ Nh·∫Øn tin
            </button>

            <div className="flex gap-2 items-center">
              <input
                type="number"
                min="1"
                value={quantity}
                onChange={(e) => setQuantity(e.target.value)}
                className="w-20 border rounded px-2 py-1"
              />
              <button
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                onClick={handleOrder}
              >
                üìù T·∫°o y√™u c·∫ßu mua
              </button>
            </div>

            {/* üóëÔ∏è N√∫t x√≥a cho admin ho·∫∑c ch·ªß s·ªü h·ªØu */}
            {canDelete && (
              <button
                onClick={handleDeleteProduct}
                className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 md:ml-2"
                title={isAdmin ? "X√≥a (admin)" : "X√≥a s·∫£n ph·∫©m c·ªßa t√¥i"}
              >
                üóëÔ∏è X√≥a s·∫£n ph·∫©m
              </button>
            )}
          </div>
        </div>
      </div>

      {/* ===================== REVIEW & RATING ===================== */}
      <div className="mt-10 border-t pt-8">
        <h2 className="text-xl font-bold mb-4">ƒê√°nh gi√° & nh·∫≠n x√©t</h2>

        {/* T·ªïng quan + bi·ªÉu ƒë·ªì t·ªâ l·ªá */}
        <div className="bg-white p-5 rounded-lg shadow mb-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between">
            <div className="flex items-center gap-4">
              <div className="text-4xl font-bold text-orange-500">
                {fmt1(avgDisplay)}
              </div>
              <div className="flex flex-col">
                <div className="text-yellow-500 text-lg">{stars(avgDisplay)}</div>
                <div className="text-sm text-gray-600">
                  {countDisplay} l∆∞·ª£t ƒë√°nh gi√°
                </div>
              </div>
            </div>

            <div className="mt-4 md:mt-0 w-full md:w-1/2">
              {[5, 4, 3, 2, 1].map((r) => {
                const total = ratingSummary.total;
                const count = ratingSummary.counts[r] || 0;
                const percent = total ? (count / total) * 100 : 0;
                return (
                  <div
                    key={r}
                    className="flex items-center gap-3 text-sm text-gray-700 mb-1"
                  >
                    <span className="w-8 text-right">{r}‚òÖ</span>
                    <div className="flex-1 bg-gray-200 h-2 rounded">
                      <div
                        className="bg-yellow-400 h-2 rounded"
                        style={{ width: `${percent}%` }}
                      />
                    </div>
                    <span className="w-10 text-right text-xs text-gray-500">
                      {percent.toFixed(0)}%
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* Form g·ª≠i review */}
        <div className="bg-gray-50 p-4 rounded-lg shadow mb-6">
          <h3 className="font-semibold mb-2">Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h3>
          <div className="flex items-center mb-2 gap-2">
            <span>Ch·∫•m ƒëi·ªÉm:</span>
            {[1, 2, 3, 4, 5].map((r) => (
              <button
                key={r}
                onClick={() => setNewRating(r)}
                className={`text-2xl ${
                  r <= newRating ? "text-yellow-500" : "text-gray-400"
                }`}
              >
                ‚òÖ
              </button>
            ))}
          </div>

          {/* Ch·ªçn ·∫£nh (preview) */}
          <input
            type="file"
            multiple
            accept="image/*"
            onChange={(e) => setReviewFiles(Array.from(e.target.files || []))}
            className="mb-3"
          />
          {reviewFiles.length > 0 && (
            <div className="flex flex-wrap gap-2 mb-3">
              {reviewFiles.map((f, i) => (
                <div key={i} className="relative">
                  <img
                    src={URL.createObjectURL(f)}
                    alt={`preview-${i}`}
                    className="w-16 h-16 object-cover rounded border"
                  />
                </div>
              ))}
            </div>
          )}

          <textarea
            className="w-full border rounded px-3 py-2 mb-3"
            placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n..."
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
          />
          <button
            onClick={submitReview}
            disabled={submitting}
            className="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 disabled:opacity-50"
          >
            {submitting ? "ƒêang g·ª≠i..." : "G·ª≠i ƒë√°nh gi√°"}
          </button>
        </div>

        {/* Danh s√°ch review */}
        {reviews.length === 0 ? (
          <p className="text-gray-500 italic">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
        ) : (
          <div className="space-y-4">
            {reviews.map((rv) => {
              const r = clamp(num(rv?.rating, 0), 1, 5);
              const imgs =
                Array.isArray(rv?.images)
                  ? rv.images
                  : typeof rv?.images === "string"
                  ? (() => {
                      try {
                        const j = JSON.parse(rv.images);
                        return Array.isArray(j) ? j : [];
                      } catch {
                        return [];
                      }
                    })()
                  : [];
              return (
                <div key={rv.id} className="border p-4 rounded-lg bg-white shadow-sm">
                  <div className="flex justify-between items-center">
                    <div className="font-semibold text-sm text-gray-700">
                      {rv.username || "Ng∆∞·ªùi d√πng ·∫©n danh"}
                    </div>
                    <div className="text-yellow-500 text-sm">
                      {"‚òÖ".repeat(r)}
                      {"‚òÜ".repeat(5 - r)}
                    </div>
                  </div>

                  <p className="mt-1 text-gray-700">{rv.content}</p>

                  {imgs.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                      {imgs.map((img, idx) => (
                        <a key={idx} href={img} target="_blank" rel="noreferrer" title="Xem ·∫£nh">
                          <img
                            src={img}
                            alt={`review-${idx}`}
                            className="w-20 h-20 object-cover rounded border"
                          />
                        </a>
                      ))}
                    </div>
                  )}

                  <div className="text-xs text-gray-400 mt-1">
                    {rv.created_at
                      ? new Date(rv.created_at).toLocaleString("vi-VN")
                      : ""}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
};

export default ProductDetail;
